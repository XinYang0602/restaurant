# 微信小程序云开发设置指南

本文档提供了设置云开发环境和排除常见问题的步骤。

## 一、基本设置

### 1. 开通云开发

1. 在微信开发者工具中，点击顶部的"云开发"按钮
2. 根据提示开通云开发服务
3. 创建一个新的云环境或使用现有环境

### 2. 配置云环境ID

1. 复制您的云环境ID（例如：`cloud1-0gib4wvca1828cf9`）
2. 在`app.ts`文件中确保正确配置云环境ID：

```typescript
// app.ts
App({
  onLaunch() {
    // 初始化云开发
    if (wx.cloud) {
      wx.cloud.init({
        env: 'cloud1-0gib4wvca1828cf9', // 请确保与您的环境ID一致
        traceUser: true,
      });
    } else {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    }
    // ...
  }
})
```

## 二、数据库设置

### 1. 创建数据库集合

1. 在云开发控制台中，点击"数据库"
2. 点击"创建集合"，输入集合名称`users`
3. 设置权限为"所有用户可读，仅创建者可写"

## 三、部署云函数

### 1. 上传云函数

1. 在微信开发者工具中，右键点击`cloudfunctions/userLogin`文件夹
2. 选择"云开发"→"上传并部署：云端安装依赖"
3. 等待部署完成

如果没有此选项，可以尝试以下步骤：
1. 在顶部菜单中点击"云开发"
2. 选择"云函数管理"
3. 点击"上传并部署"按钮

### 2. 验证云函数

1. 在云开发控制台中，点击"云函数"
2. 确认`userLogin`函数已部署成功
3. 可以点击"测试"按钮进行测试

## 四、常见问题排查

### 1. 云函数调用失败

**症状**：点击登录按钮，但没有任何反应或显示"登录失败"

**排查步骤**：
1. 检查开发者工具的"调试器"→"Console"面板，查看日志输出
2. 确认是否有权限请求用户信息：
   ```
   检查 getUserProfile 是否有错误
   检查小程序是否在真机上测试（模拟器可能无法正常获取用户信息）
   ```
3. 检查云函数是否成功调用：
   ```
   查找"调用云函数userLogin"相关日志
   检查是否有云函数返回结果
   ```
4. 检查云函数错误日志：
   ```
   在云开发控制台中，点击"云函数"
   选择"userLogin"函数
   点击"日志"查看云函数执行日志
   ```

### 2. 数据库操作失败

**症状**：云函数调用成功，但用户数据未保存到数据库

**排查步骤**：
1. 检查云函数日志中是否有数据库操作相关错误
2. 确认数据库集合权限设置正确
3. 检查数据库操作代码是否有误:
   ```
   确保使用了正确的OPENID作为查询条件
   确保数据库操作的语法和字段名称正确
   ```

### 3. 环境ID配置问题

**症状**：云函数或数据库操作总是失败

**排查步骤**：
1. 确认所有地方使用的云环境ID一致：
   ```
   app.ts文件中的环境ID
   cloudfunctions/userLogin/index.js中的环境ID
   ```
2. 确认环境ID是否有效（在云开发控制台中验证）

## 五、测试登录功能

### 1. 测试步骤

1. 确保在真机上测试（推荐）或在开发者工具上启用"微信授权"
2. 点击小程序中的"微信一键登录"按钮
3. 允许获取用户信息的授权请求
4. 观察登录结果和控制台输出

### 2. 验证数据

1. 登录成功后，在云开发控制台中
2. 检查"数据库"→"users"集合
3. 确认是否有新增的用户数据记录 